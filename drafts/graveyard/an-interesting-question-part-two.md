Ok, lets give this a [different shot](https://github.com/inaimathi/cl-clocking). Since this version is written in Common Lisp, we don't need to worry about the effect JVM overhead on energy consumption. And also, since we're giving this a different shot, lets establish a baseline.

```commonlisp
(defun record-usage (&key (file #p"baseline.txt"))
  (when (probe-file file) (delete-file file))
  (with-open-file (s file :direction :output :if-does-not-exist :create :if-exists :append)
    (loop
       do (format
	   s "~s~%"
	   (cons (get-universal-time)
		 (mapcar
		  (lambda (b)
		    (loop for k in (list "name" "capacity" "energy_now" "energy_full")
		       collect (cdr (assoc k b :test #'string=))))
		  (battery-status))))
       do (force-output s)
       do (sleep 60))))
```

That function mostly sleeps, and dumps battery info into a file on disk once every minute. I think the function itself consumes pretty minimal energy. Like well under the noise level we'll be trying to sort through later. So we can safely ignore it. Killing all user processes except for `emacs` and `sbcl`, and disabling power-save features, when we let this run for a while, we get


```
(3743973070 ("BAT0" 97 21340000 21910000) ("BAT1" 95 46160000 48420000))
(3743973130 ("BAT0" 97 21340000 21910000) ("BAT1" 94 45880000 48420000))
(3743973190 ("BAT0" 97 21340000 21910000) ("BAT1" 94 45600000 48420000))
(3743973250 ("BAT0" 97 21340000 21910000) ("BAT1" 93 45320000 48420000))
(3743973310 ("BAT0" 97 21340000 21910000) ("BAT1" 93 45050000 48420000))
(3743973370 ("BAT0" 97 21340000 21910000) ("BAT1" 92 44790000 48420000))
(3743973430 ("BAT0" 97 21340000 21910000) ("BAT1" 92 44550000 48420000))
(3743973490 ("BAT0" 97 21340000 21910000) ("BAT1" 91 44290000 48420000))
(3743973550 ("BAT0" 97 21340000 21910000) ("BAT1" 90 44050000 48420000))
(3743973610 ("BAT0" 97 21340000 21910000) ("BAT1" 90 43790000 48420000))
(3743973670 ("BAT0" 97 21340000 21910000) ("BAT1" 89 43540000 48420000))
(3743973730 ("BAT0" 97 21340000 21910000) ("BAT1" 89 43290000 48420000))
(3743973790 ("BAT0" 97 21340000 21910000) ("BAT1" 88 43050000 48420000))
(3743973850 ("BAT0" 97 21340000 21910000) ("BAT1" 88 42790000 48420000))
(3743973910 ("BAT0" 97 21340000 21910000) ("BAT1" 87 42550000 48420000))
(3743973971 ("BAT0" 97 21340000 21910000) ("BAT1" 87 42290000 48420000))
(3743974031 ("BAT0" 97 21340000 21910000) ("BAT1" 86 42040000 48420000))
(3743974091 ("BAT0" 97 21340000 21910000) ("BAT1" 86 41790000 48420000))
(3743974151 ("BAT0" 97 21340000 21910000) ("BAT1" 85 41550000 48420000))
(3743974211 ("BAT0" 97 21340000 21910000) ("BAT1" 85 41290000 48420000))
(3743974271 ("BAT0" 97 21340000 21910000) ("BAT1" 84 41040000 48420000))
(3743974331 ("BAT0" 97 21340000 21910000) ("BAT1" 84 40800000 48420000))
(3743974391 ("BAT0" 97 21340000 21910000) ("BAT1" 83 40540000 48420000))
(3743974451 ("BAT0" 97 21340000 21910000) ("BAT1" 83 40300000 48420000))
(3743974511 ("BAT0" 97 21340000 21910000) ("BAT1" 82 40040000 48420000))
(3743974571 ("BAT0" 97 21340000 21910000) ("BAT1" 82 39790000 48420000))
(3743974631 ("BAT0" 97 21340000 21910000) ("BAT1" 81 39530000 48420000))
(3743974691 ("BAT0" 97 21340000 21910000) ("BAT1" 81 39280000 48420000))
(3743974751 ("BAT0" 97 21340000 21910000) ("BAT1" 80 39020000 48420000))
(3743974811 ("BAT0" 97 21340000 21910000) ("BAT1" 80 38780000 48420000))
(3743974871 ("BAT0" 97 21340000 21910000) ("BAT1" 79 38520000 48420000))
(3743974931 ("BAT0" 97 21340000 21910000) ("BAT1" 79 38260000 48420000))
(3743974991 ("BAT0" 97 21340000 21910000) ("BAT1" 78 38000000 48420000))
(3743975051 ("BAT0" 97 21340000 21910000) ("BAT1" 77 37750000 48420000))
(3743975111 ("BAT0" 97 21340000 21910000) ("BAT1" 77 37490000 48420000))
(3743975171 ("BAT0" 97 21340000 21910000) ("BAT1" 76 37230000 48420000))
(3743975232 ("BAT0" 97 21340000 21910000) ("BAT1" 76 36980000 48420000))
(3743975292 ("BAT0" 97 21340000 21910000) ("BAT1" 75 36730000 48420000))
(3743975352 ("BAT0" 97 21340000 21910000) ("BAT1" 75 36460000 48420000))
(3743975412 ("BAT0" 97 21340000 21910000) ("BAT1" 74 36210000 48420000))
(3743975472 ("BAT0" 97 21340000 21910000) ("BAT1" 74 35940000 48420000))
(3743975532 ("BAT0" 97 21340000 21910000) ("BAT1" 73 35680000 48420000))
(3743975592 ("BAT0" 97 21340000 21910000) ("BAT1" 73 35420000 48420000))
(3743975652 ("BAT0" 97 21340000 21910000) ("BAT1" 72 35160000 48420000))
(3743975712 ("BAT0" 97 21340000 21910000) ("BAT1" 72 34910000 48420000))
(3743975772 ("BAT0" 97 21340000 21910000) ("BAT1" 71 34640000 48420000))
(3743975832 ("BAT0" 97 21340000 21910000) ("BAT1" 71 34380000 48420000))
(3743975892 ("BAT0" 97 21340000 21910000) ("BAT1" 70 34120000 48420000))
(3743975952 ("BAT0" 97 21340000 21910000) ("BAT1" 69 33860000 48420000))
(3743976012 ("BAT0" 97 21340000 21910000) ("BAT1" 69 33590000 48420000))
(3743976072 ("BAT0" 97 21340000 21910000) ("BAT1" 68 33330000 48420000))
(3743976132 ("BAT0" 97 21340000 21910000) ("BAT1" 68 33060000 48420000))
(3743976192 ("BAT0" 97 21340000 21910000) ("BAT1" 67 32810000 48420000))
(3743976252 ("BAT0" 97 21340000 21910000) ("BAT1" 67 32530000 48420000))
(3743976312 ("BAT0" 97 21340000 21910000) ("BAT1" 66 32270000 48420000))
(3743976372 ("BAT0" 97 21340000 21910000) ("BAT1" 66 32020000 48420000))
(3743976432 ("BAT0" 97 21340000 21910000) ("BAT1" 65 31760000 48420000))
(3743976492 ("BAT0" 97 21340000 21910000) ("BAT1" 65 31480000 48420000))
(3743976553 ("BAT0" 97 21340000 21910000) ("BAT1" 64 31220000 48420000))
(3743976613 ("BAT0" 97 21340000 21910000) ("BAT1" 63 30950000 48420000))
(3743976673 ("BAT0" 97 21340000 21910000) ("BAT1" 63 30680000 48420000))
(3743976733 ("BAT0" 97 21340000 21910000) ("BAT1" 62 30410000 48420000))
(3743976793 ("BAT0" 97 21340000 21910000) ("BAT1" 62 30150000 48420000))
(3743976853 ("BAT0" 97 21340000 21910000) ("BAT1" 61 29880000 48420000))
(3743976913 ("BAT0" 97 21340000 21910000) ("BAT1" 61 29610000 48420000))
(3743976973 ("BAT0" 97 21340000 21910000) ("BAT1" 60 29340000 48420000))
(3743977033 ("BAT0" 97 21340000 21910000) ("BAT1" 60 29080000 48420000))
(3743977093 ("BAT0" 97 21340000 21910000) ("BAT1" 59 28810000 48420000))
(3743977153 ("BAT0" 97 21340000 21910000) ("BAT1" 58 28530000 48420000))
(3743977213 ("BAT0" 97 21340000 21910000) ("BAT1" 58 28270000 48420000))
(3743977273 ("BAT0" 97 21340000 21910000) ("BAT1" 57 27990000 48420000))
(3743977333 ("BAT0" 97 21340000 21910000) ("BAT1" 57 27720000 48420000))
(3743977393 ("BAT0" 97 21340000 21910000) ("BAT1" 56 27450000 48420000))
(3743977453 ("BAT0" 97 21330000 21910000) ("BAT1" 56 27180000 48420000))
(3743977513 ("BAT0" 97 21330000 21910000) ("BAT1" 55 26920000 48420000))
(3743977573 ("BAT0" 97 21330000 21910000) ("BAT1" 55 26650000 48420000))
(3743977633 ("BAT0" 97 21330000 21910000) ("BAT1" 54 26370000 48420000))
(3743977693 ("BAT0" 97 21330000 21910000) ("BAT1" 53 26110000 48420000))
(3743977753 ("BAT0" 97 21330000 21910000) ("BAT1" 53 25820000 48420000))
(3743977814 ("BAT0" 97 21330000 21910000) ("BAT1" 52 25560000 48420000))
(3743977874 ("BAT0" 97 21330000 21910000) ("BAT1" 52 25280000 48420000))
(3743977934 ("BAT0" 97 21330000 21910000) ("BAT1" 51 25020000 48420000))
(3743977994 ("BAT0" 97 21330000 21910000) ("BAT1" 51 24730000 48420000))
(3743978054 ("BAT0" 97 21330000 21910000) ("BAT1" 50 24460000 48420000))
(3743978114 ("BAT0" 97 21330000 21910000) ("BAT1" 49 24190000 48420000))
(3743978174 ("BAT0" 97 21330000 21910000) ("BAT1" 49 23920000 48420000))
(3743978234 ("BAT0" 97 21330000 21910000) ("BAT1" 48 23640000 48420000))
(3743978294 ("BAT0" 97 21330000 21910000) ("BAT1" 48 23370000 48420000))
(3743978354 ("BAT0" 97 21330000 21910000) ("BAT1" 47 23100000 48420000))
(3743978414 ("BAT0" 97 21330000 21910000) ("BAT1" 47 22810000 48420000))
(3743978474 ("BAT0" 97 21330000 21910000) ("BAT1" 46 22540000 48420000))
(3743978534 ("BAT0" 97 21330000 21910000) ("BAT1" 45 22270000 48420000))
(3743978594 ("BAT0" 97 21330000 21910000) ("BAT1" 45 22000000 48420000))
(3743978654 ("BAT0" 97 21330000 21910000) ("BAT1" 44 21710000 48420000))
(3743978714 ("BAT0" 97 21330000 21910000) ("BAT1" 44 21440000 48420000))
(3743978774 ("BAT0" 97 21330000 21910000) ("BAT1" 43 21170000 48420000))
(3743978834 ("BAT0" 97 21330000 21910000) ("BAT1" 43 20890000 48420000))
(3743978894 ("BAT0" 97 21330000 21910000) ("BAT1" 42 20610000 48420000))
(3743978954 ("BAT0" 97 21330000 21910000) ("BAT1" 42 20340000 48420000))
(3743979014 ("BAT0" 97 21330000 21910000) ("BAT1" 41 20070000 48420000))
(3743979074 ("BAT0" 97 21330000 21910000) ("BAT1" 40 19780000 48420000))
(3743979135 ("BAT0" 97 21330000 21910000) ("BAT1" 40 19510000 48420000))
(3743979195 ("BAT0" 97 21330000 21910000) ("BAT1" 39 19230000 48420000))
(3743979255 ("BAT0" 97 21330000 21910000) ("BAT1" 39 18960000 48420000))
(3743979315 ("BAT0" 97 21330000 21910000) ("BAT1" 38 18670000 48420000))
(3743979375 ("BAT0" 97 21330000 21910000) ("BAT1" 38 18400000 48420000))
(3743979435 ("BAT0" 97 21330000 21910000) ("BAT1" 37 18130000 48420000))
(3743979495 ("BAT0" 97 21330000 21910000) ("BAT1" 36 17850000 48420000))
(3743979555 ("BAT0" 97 21330000 21910000) ("BAT1" 36 17560000 48420000))
(3743979615 ("BAT0" 97 21330000 21910000) ("BAT1" 35 17280000 48420000))
(3743979675 ("BAT0" 97 21330000 21910000) ("BAT1" 35 17010000 48420000))
(3743979735 ("BAT0" 97 21330000 21910000) ("BAT1" 34 16710000 48420000))
(3743979795 ("BAT0" 97 21330000 21910000) ("BAT1" 33 16440000 48420000))
(3743979855 ("BAT0" 97 21330000 21910000) ("BAT1" 33 16160000 48420000))
(3743979915 ("BAT0" 97 21330000 21910000) ("BAT1" 32 15890000 48420000))
(3743979975 ("BAT0" 97 21330000 21910000) ("BAT1" 32 15600000 48420000))
(3743980035 ("BAT0" 97 21330000 21910000) ("BAT1" 31 15330000 48420000))
(3743980095 ("BAT0" 97 21330000 21910000) ("BAT1" 31 15050000 48420000))
(3743980155 ("BAT0" 97 21330000 21910000) ("BAT1" 30 14760000 48420000))
(3743980215 ("BAT0" 97 21330000 21910000) ("BAT1" 29 14480000 48420000))
(3743980275 ("BAT0" 97 21330000 21910000) ("BAT1" 29 14200000 48420000))
(3743980335 ("BAT0" 97 21330000 21910000) ("BAT1" 28 13930000 48420000))
(3743980395 ("BAT0" 97 21330000 21910000) ("BAT1" 28 13640000 48420000))
(3743980456 ("BAT0" 97 21330000 21910000) ("BAT1" 27 13370000 48420000))
(3743980516 ("BAT0" 97 21330000 21910000) ("BAT1" 27 13080000 48420000))
(3743980576 ("BAT0" 97 21330000 21910000) ("BAT1" 26 12800000 48420000))
(3743980636 ("BAT0" 97 21330000 21910000) ("BAT1" 25 12520000 48420000))
(3743980696 ("BAT0" 97 21330000 21910000) ("BAT1" 25 12240000 48420000))
(3743980756 ("BAT0" 97 21330000 21910000) ("BAT1" 24 11960000 48420000))
(3743980816 ("BAT0" 97 21330000 21910000) ("BAT1" 24 11670000 48420000))
(3743980876 ("BAT0" 97 21330000 21910000) ("BAT1" 23 11390000 48420000))
(3743980936 ("BAT0" 97 21330000 21910000) ("BAT1" 22 11110000 48420000))
(3743980996 ("BAT0" 97 21330000 21910000) ("BAT1" 22 10830000 48420000))
(3743981056 ("BAT0" 97 21330000 21910000) ("BAT1" 21 10540000 48420000))
(3743981116 ("BAT0" 97 21330000 21910000) ("BAT1" 21 10250000 48420000))
(3743981176 ("BAT0" 97 21330000 21910000) ("BAT1" 20 9970000 48420000))
(3743981236 ("BAT0" 97 21330000 21910000) ("BAT1" 19 9670000 48420000))
(3743981296 ("BAT0" 97 21330000 21910000) ("BAT1" 19 9400000 48420000))
(3743981356 ("BAT0" 97 21330000 21910000) ("BAT1" 18 9110000 48420000))
(3743981416 ("BAT0" 97 21330000 21910000) ("BAT1" 18 8840000 48420000))
(3743981476 ("BAT0" 97 21330000 21910000) ("BAT1" 17 8540000 48420000))
(3743981536 ("BAT0" 97 21330000 21910000) ("BAT1" 17 8260000 48420000))
(3743981596 ("BAT0" 97 21330000 21910000) ("BAT1" 16 7970000 48420000))
(3743981656 ("BAT0" 97 21330000 21910000) ("BAT1" 15 7690000 48420000))
(3743981716 ("BAT0" 97 21330000 21910000) ("BAT1" 15 7400000 48420000))
(3743981777 ("BAT0" 97 21330000 21910000) ("BAT1" 14 7120000 48420000))
(3743981837 ("BAT0" 97 21330000 21910000) ("BAT1" 14 6840000 48420000))
(3743981897 ("BAT0" 97 21330000 21910000) ("BAT1" 13 6540000 48420000))
(3743981957 ("BAT0" 97 21330000 21910000) ("BAT1" 12 6250000 48420000))
(3743982017 ("BAT0" 97 21330000 21910000) ("BAT1" 12 5970000 48420000))
(3743982077 ("BAT0" 97 21330000 21910000) ("BAT1" 11 5690000 48420000))
(3743982137 ("BAT0" 97 21330000 21910000) ("BAT1" 11 5390000 48420000))
(3743982197 ("BAT0" 97 21330000 21910000) ("BAT1" 10 5110000 48420000))
(3743982257 ("BAT0" 97 21330000 21910000) ("BAT1" 9 4820000 48420000))
(3743982317 ("BAT0" 97 21330000 21910000) ("BAT1" 6 3010000 48420000))
(3743982377 ("BAT0" 97 21330000 21910000) ("BAT1" 5 2720000 48420000))
(3743982437 ("BAT0" 96 21200000 21910000) ("BAT1" 5 2580000 48420000))
(3743982497 ("BAT0" 95 20940000 21910000) ("BAT1" 5 2580000 48420000))
(3743982557 ("BAT0" 94 20680000 21910000) ("BAT1" 5 2580000 48420000))
(3743982617 ("BAT0" 93 20430000 21910000) ("BAT1" 5 2580000 48420000))
(3743982677 ("BAT0" 92 20160000 21910000) ("BAT1" 5 2580000 48420000))
(3743982737 ("BAT0" 90 19900000 21910000) ("BAT1" 5 2580000 48420000))
(3743982797 ("BAT0" 89 19630000 21910000) ("BAT1" 5 2580000 48420000))
(3743982857 ("BAT0" 88 19370000 21910000) ("BAT1" 5 2580000 48420000))
(3743982917 ("BAT0" 87 19100000 21910000) ("BAT1" 5 2580000 48420000))
(3743982977 ("BAT0" 85 18830000 21910000) ("BAT1" 5 2580000 48420000))
(3743983038 ("BAT0" 84 18560000 21910000) ("BAT1" 5 2580000 48420000))
(3743983098 ("BAT0" 83 18300000 21910000) ("BAT1" 5 2580000 48420000))
(3743983158 ("BAT0" 82 18030000 21910000) ("BAT1" 5 2580000 48420000))
(3743983218 ("BAT0" 81 17750000 21910000) ("BAT1" 5 2580000 48420000))
(3743983278 ("BAT0" 79 17480000 21910000) ("BAT1" 5 2580000 48420000))
(3743983338 ("BAT0" 78 17210000 21910000) ("BAT1" 5 2580000 48420000))
(3743983398 ("BAT0" 77 16940000 21910000) ("BAT1" 5 2580000 48420000))
(3743983458 ("BAT0" 76 16670000 21910000) ("BAT1" 5 2580000 48420000))
(3743983518 ("BAT0" 74 16390000 21910000) ("BAT1" 5 2580000 48420000))
(3743983578 ("BAT0" 73 16120000 21910000) ("BAT1" 5 2580000 48420000))
(3743983638 ("BAT0" 72 15830000 21910000) ("BAT1" 5 2580000 48420000))
(3743983698 ("BAT0" 71 15560000 21910000) ("BAT1" 5 2570000 48420000))
(3743983758 ("BAT0" 69 15280000 21910000) ("BAT1" 5 2570000 48420000))
(3743983818 ("BAT0" 68 15010000 21910000) ("BAT1" 5 2570000 48420000))
(3743983878 ("BAT0" 67 14720000 21910000) ("BAT1" 5 2570000 48420000))
(3743983938 ("BAT0" 65 14450000 21910000) ("BAT1" 5 2570000 48420000))
(3743983998 ("BAT0" 64 14170000 21910000) ("BAT1" 5 2570000 48420000))
(3743984058 ("BAT0" 63 13890000 21910000) ("BAT1" 5 2570000 48420000))
(3743984118 ("BAT0" 62 13600000 21910000) ("BAT1" 5 2570000 48420000))
(3743984178 ("BAT0" 60 13320000 21910000) ("BAT1" 5 2570000 48420000))
(3743984238 ("BAT0" 59 13040000 21910000) ("BAT1" 5 2570000 48420000))
(3743984298 ("BAT0" 58 12750000 21910000) ("BAT1" 5 2570000 48420000))
(3743984359 ("BAT0" 56 12470000 21910000) ("BAT1" 5 2570000 48420000))
(3743984419 ("BAT0" 55 12180000 21910000) ("BAT1" 5 2570000 48420000))
(3743984479 ("BAT0" 54 11900000 21910000) ("BAT1" 5 2570000 48420000))
(3743984539 ("BAT0" 52 11610000 21910000) ("BAT1" 5 2570000 48420000))
(3743984599 ("BAT0" 51 11330000 21910000) ("BAT1" 5 2570000 48420000))
```

So baseline system usage is around 1% of the battery per two minutes, and my backup battery kicks in when the main one is at 5%. The backup burns around 1% per minute, which means I'm looking at a base system lifetime of about 5 hours. I'm mildly disappointed, if I'm honest, but we measure things to see what they are not what we [want them to be](TODO - lenovo tech spec battery claims).

Now that we have that, we can see what happens when we actually run things.

```
(3744019314 ("BAT0" 99 21840000 21880000) ("BAT1" 93 44020000 46890000))
(3744019374 ("BAT0" 99 21840000 21880000) ("BAT1" 93 43750000 46890000))
(3744019435 ("BAT0" 99 21840000 21880000) ("BAT1" 92 43410000 46890000))
(3744019495 ("BAT0" 99 21840000 21880000) ("BAT1" 91 42950000 46890000))
(3744019555 ("BAT0" 99 21840000 21880000) ("BAT1" 90 42490000 46890000))
(3744019615 ("BAT0" 99 21840000 21880000) ("BAT1" 89 42020000 46890000))
(3744019676 ("BAT0" 99 21840000 21880000) ("BAT1" 89 41740000 46890000))
(3744019736 ("BAT0" 99 21840000 21880000) ("BAT1" 88 41360000 46890000))
(3744019796 ("BAT0" 99 21840000 21880000) ("BAT1" 87 40890000 46890000))
(3744019856 ("BAT0" 99 21840000 21880000) ("BAT1" 86 40440000 46890000))
(3744019917 ("BAT0" 99 21840000 21880000) ("BAT1" 85 40030000 46890000))
(3744019977 ("BAT0" 99 21840000 21880000) ("BAT1" 84 39740000 46890000))
(3744020037 ("BAT0" 99 21840000 21880000) ("BAT1" 83 39330000 46890000))
(3744020097 ("BAT0" 99 21840000 21880000) ("BAT1" 82 38860000 46890000))
(3744020158 ("BAT0" 99 21840000 21880000) ("BAT1" 81 38430000 46890000))
(3744020218 ("BAT0" 99 21840000 21880000) ("BAT1" 81 38010000 46890000))
(3744020278 ("BAT0" 99 21840000 21880000) ("BAT1" 80 37610000 46890000))
(3744020338 ("BAT0" 99 21840000 21880000) ("BAT1" 79 37210000 46890000))
(3744020398 ("BAT0" 99 21840000 21880000) ("BAT1" 78 36890000 46890000))
(3744021339 ("BAT0" 99 21840000 21880000) ("BAT1" 77 36300000 46890000))
```

```commonlisp
(defparameter *generator* (session-token:make-generator :token-length 1000))
(defun gen! () (funcall *generator*))

(defun sha256 (str)
  (ironclad:byte-array-to-hex-string
   (ironclad:digest-sequence
    :sha256 (ironclad:ascii-string-to-byte-array str))))

(defun tcp-send (host port input)
  (let* ((sock (usocket:socket-connect host port))
         (stream (usocket:socket-stream sock)))
    (format stream "~a" input)
    (force-output stream)
    (read-sequence (make-string 2) stream)
    (usocket:socket-close sock)))

(defun tcp-receive (server)
  (let* ((sock (usocket:socket-accept server))
         (stream (usocket:socket-stream sock))
         (buf (make-string 1000)))
    (read-sequence buf stream)
    (format stream "~a" "ok")
    (force-output stream)
    (usocket:socket-close sock)
    buf))

(defun battery-status ()
  (loop for b in (trivial-battery:battery-info)
     collect (trivial-battery:battery-details
              (cdr (assoc "name" b :test #'string=)))))

(defun profile! (&key (times 1) (port 8080))
  (let* ((server (usocket:socket-listen usocket:*wildcard-host* port :reuse-address t))
         (server-thread (bt:make-thread (lambda () (loop (tcp-receive server)))))
         (before (battery-status)))
    (loop repeat times
       do (let ((inp (gen!)))
            (sha256 inp)
            (tcp-send "localhost" port inp)))
    (usocket:socket-close server)
    (bt:destroy-thread server-thread)
    (list :before before :after (battery-status))))
```

Since this version is written in CL, we don't need to worry about the effect of JVM overhead on energy consumption. On the downside, the only implementation of [ECDSA for Common Lisp](https://github.com/krkhan/cl-ecc) is a prototype that isn't yet included in the default `quicklisp` distribution. This makes it a bit more difficult to test `ecdsa-sign` and `ecdsa-verify` steps, but we already got decently reliable results for that [last time](/posts/an-interesting-question). What we're _really_ after is a TCP test that doesn't saturate memory, and I'm a lot more comfortable with Common Lisps' [`usocket` library](https://common-lisp.net/project/usocket/) than I am with [clj-sockets](https://github.com/atroche/clj-sockets).

Also, I know that [`slime`](https://common-lisp.net/project/slime/) has a pretty good built-in profiler, so we won't have to worry about including that as a separate library. A preliminary run with `M-x profile-package CL-CLOCKING` and `(cl-clocking::profile! :times 5000000)` (admittedly with some minor prior REPL testing) shows us

```
  seconds  |     gc     |      consed     |    calls   |  sec/call  |  name
------------------------------------------------------------------
 10886.748 |      7.400 | 107,713,781,632 |  5,055,014 |   0.002154 | CL-CLOCKING::TCP-RECEIVE
  9789.168 |      7.380 |  83,018,785,424 |  5,055,010 |   0.001937 | CL-CLOCKING::TCP-SEND
   686.740 |      0.020 |  31,413,748,800 |  5,055,010 |   0.000136 | CL-CLOCKING::GEN!
   248.054 |      0.000 |       1,147,808 |          4 |  62.013577 | CL-CLOCKING::PROFILE!
   209.580 |      0.000 |       2,777,824 |  5,055,010 |   0.000041 | CL-CLOCKING::SHA256
     0.084 |      0.000 |       3,027,360 |          8 |   0.010499 | CL-CLOCKING::BATTERY-STATUS
------------------------------------------------------------------
 21820.375 |     14.800 | 222,153,268,848 | 20,220,056 |            | Total

estimated total profiling overhead: 22.16 seconds
overhead estimation parameters:
  2.4e-8s/call, 1.096e-6s total profiling, 5.04e-7s internal profiling
```

as the result of `M-x slime-profile-report`. So, even without doing anything at all with batteries, we know that `tcp-receive` and `tcp-send` are going to dominate the energy expenditure here. Which shouldn't be a surprise, really; if absolutely nothing else, `tcp-receive` needs to allocate 1k of memory into which to read the incoming message.

Ok, lets wire up some before/after timestamps and see what the results here are.

```
CL-USER> (list :start (local-time:now) :result (cl-clocking::profile! :times 5000000 :port 8081) :end (local-time:now))
(:START @2018-08-18T15:00:47.816870-04:00 :RESULT
 (:BEFORE
  ((("name" . "BAT0") ("alarm" . 1128000) ("capacity" . 99)
    ("capacity_level" . "Normal") ("cycle_count" . 0)
    ("energy_full" . 21950000) ("energy_full_design" . 23480000)
    ("energy_now" . 21850000) ("manufacturer" . "LGC")
    ("model_name" . "45N1113") ("power_now" . 0) ("present" . 1)
    ("serial_number" . 1872) ("status" . "Unknown") ("technology" . "Li-ion")
    ("type" . "Battery") ("voltage_min_design" . 11400000)
    ("voltage_now" . 12614000))
   (("name" . "BAT1") ("alarm" . 2448000) ("capacity" . 22)
    ("capacity_level" . "Normal") ("cycle_count" . 0)
    ("energy_full" . 48920000) ("energy_full_design" . 47520000)
    ("energy_now" . 11070000) ("manufacturer" . "SMP")
    ("model_name" . "45N1736") ("power_now" . 17860000) ("present" . 1)
    ("serial_number" . 380) ("status" . "Charging") ("technology" . "Li-ion")
    ("type" . "Battery") ("voltage_min_design" . 10800000)
    ("voltage_now" . 10917000)))
  :AFTER
  ((("name" . "BAT0") ("alarm" . 1128000) ("capacity" . 99)
    ("capacity_level" . "Normal") ("cycle_count" . 0)
    ("energy_full" . 21950000) ("energy_full_design" . 23480000)
    ("energy_now" . 21840000) ("manufacturer" . "LGC")
    ("model_name" . "45N1113") ("power_now" . 0) ("present" . 1)
    ("serial_number" . 1872) ("status" . "Unknown") ("technology" . "Li-ion")
    ("type" . "Battery") ("voltage_min_design" . 11400000)
    ("voltage_now" . 12612000))
   (("name" . "BAT1") ("alarm" . 2448000) ("capacity" . 46)
    ("capacity_level" . "Normal") ("cycle_count" . 0)
    ("energy_full" . 48920000) ("energy_full_design" . 47520000)
    ("energy_now" . 22830000) ("manufacturer" . "SMP")
    ("model_name" . "45N1736") ("power_now" . 14903000) ("present" . 1)
    ("serial_number" . 380) ("status" . "Charging") ("technology" . "Li-ion")
    ("type" . "Battery") ("voltage_min_design" . 10800000)
    ("voltage_now" . 11172000))))
 :END @2018-08-18T15:52:22.810642-04:00)

measuring PROFILE overhead..done

  seconds  |     gc     |      consed     |    calls   |  sec/call  |  name
------------------------------------------------------------------
  3572.316 |     11.932 | 111,147,058,064 |  5,000,001 |   0.000714 | CL-CLOCKING::TCP-RECEIVE
  2494.496 |     11.924 |  81,189,133,664 |  5,000,000 |   0.000499 | CL-CLOCKING::TCP-SEND
   825.548 |      0.008 |  29,993,704,848 |  5,000,000 |   0.000165 | CL-CLOCKING::GEN!
   226.748 |      0.000 |          32,624 |  5,000,000 |   0.000045 | CL-CLOCKING::SHA256
    34.320 |      0.000 |       1,132,560 |          2 |  17.159998 | CL-CLOCKING::PROFILE!
     0.040 |      0.000 |         805,312 |          2 |   0.020000 | CL-CLOCKING::BATTERY-STATUS
------------------------------------------------------------------
  7153.468 |     23.864 | 222,331,867,072 | 20,000,005 |            | Total

estimated total profiling overhead: 25.44 seconds
overhead estimation parameters:
  2.4e-8s/call, 1.2720001e-6s total profiling, 4.96e-7s internal profiling

CL-USER>
```

That entire clocking run took 52 minutes, and generated 5 million calls each to `sha256`, `tcp-send` and `tcp-receive`. `tcp-receive` on its own accounts for about half of the energy, memory and time cost of the profiling operation. `tcp-send` accounts for about 35% of the same, and the `sha256` operation ranks below generating dummy data to run operations on. So that sets expectations pretty well.
